# 프로세스 동기화

## 동기화란

### 동기화의 의미

프로세스들 사이의 수행 시기를 맞추는 것

- 실행 순서 제어: 프로세스를 올바른 순서대로 실행하기
- 상호 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기

동기화는 특정 자원에 접근할 때 한 개의 프로세스만 접근하게 하거나, 프로세스를 올바른 순서대로 실행하게 하는 것을 의미한다.

### 실행 순서 제어를 위한 동기화

동시에 실행되는 프로세스를 올바른 순서대로 실행하는 것.

ex) Writer 프로세스가 Book.txt에 값을 저장하고나서 Reader 프로세스가 실행되어야 한다.

### 상호 배제를 위한 동기화

`상호 배제`

공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘

ex) 계좌 입출금

동시에 접근해서는 안 되는 자원에 동시에 접근하지 못하게 하는 것이 상호 배제를 위한 동기화이다.

## 생산자와 소비자 문제

```cpp
#include <iostream>
#include <queue>
#include <thread>

void produce();
void consume();

//std::queue<int> q;
int sum = 0;

int main() {

    std::cout << "초기 합계: " <<  sum << std::endl;
    std::thread producer(produce);
    std::thread consumer(consume);

    producer.join();
    consumer.join();
    
    std::cout << "producer, consumer 스레드 실행 이후 합계: " <<  sum << std::endl;
    
    return 0;
}

void produce() {
    for(int i = 0; i < 100000; i++) {
        // q.push(1);
        sum++;
    }
}

void consume() {
    for(int i = 0; i < 100000; i++) {
        // q.pop();
        sum--;
    }
}
```
```
초기 합계 : 10
producer, consumer 스레드 실행 이후 합계 : 63078
```

## 공유 자원과 임계 구역

**공유 자원**

공동으로 이용하는 변수, 파일, 장치 등의 자원

**임계 구역**

공유 자원에 접근하는 코드 중 동시에 실행하면 문제가 발생하는 코드 영역

### 레이스 컨디션

프로세스가 동시 다발적으로 임계 구역의 코드를 실행하면 문제가 발생하고 이를 레이스 컨디션이라고 한다.

→ 컴퓨터는 고급 언어가 아닌 저급 언어를 실행하기 때문에 여러 줄의 저급 언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥 교환이 일어날 수 있다. 실행 과정에서 문맥 교환이 일어나면 문제가 발생한다.

### 상호 배제를 위한 동기화 - 세 가지 원칙

- 상호 배제(mutual exclusion): 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
- 진행(progress): 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
- 유한 대기(bounded waiting): 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다.(무한정 대기x)

# 동기화 기법

## 뮤텍스 락(Mutex lock: MUTual EXclusion lock)

동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 다시 말해 상호 배제를 위한 동기화 도구이다.

`전역 변수 lock` : 프로세스들이 공유하는 전역 변수

`acquire 함수` : 프로세스가 임계 구역에 진입하기 전에 호출하는 함수. 

임계 구역이 잠겨있다면 임계 구역이 열릴 때까지 (lock이 false가 될 때까지) 임계 구역을 반복적으로 확인하고,  임계 구역이 열려 있다면 임계 구역을 잠그는(lock을 true로 바꾸는) 함수이다.

이러한 대기 방식을 바쁜 대기라고 한다.

`release 함수` : 임계 구역에서의 작업이 끝나고 호출하는 함수(lock을 false로 바꾸는 함수)

```java
acquire(); 
// 임계 구역
release();
```

## 세마포

일반화된 방식의 동기화 도구. 뮤텍스 락과 다르게 공유 자원이 여러개 있는 상황에서도 적용이 가능하다.

`전역 변수 S` : 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)를 나타낸다.

`wait 함수` : 임계 구역에 들어가도 좋은지 안되는지 알려주는 함수

`signal 함수` : 임계 구역 앞에서 기다리는 프로세스에게 가도 된다는 신호를 주는 함수

```java
wait() {
	S--;
	if(S < 0) {
		add this process to Queue;
		sleep();
	}
}

signal() {
	S++;
	if(S >= 0) {
		remove a process p from Queue;
		wakeup(p);
	}
}
```

→ 바쁜 대기 대신 사용할 수 있는 방법. wait함수는 사용할 수 있는 자원이 없을 경우 해당 프로세스 상태를 대기 상태로 만들고 프로세스의 PCB를 세마포를 위한 대기 큐에 넣는다.

다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는 대기 중인 프로세스를 대기 큐에서 제거하고 프로세스 상태를 준비 상태로 변경한 뒤 준비 큐로 옮겨준다.

→세마포를 이용해 프로세스의 순서를 제어하는 것도 가능하다.

## 모니터

모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스를 묶어서 관리하며 프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근 가능하다.

세마포와 마찬가지로 상호 배제를 위한 동기화 외에 실행 순서 제어를 위한 동기화도 제공한다.

 `조건 변수(condition variable)` 을 사용해 프로세스나 스레드의 실행 순서를 제어한다.

- 실행 순서 제어를 위한 동기화
  1. 특정 프로세스가 아직 실행될 조건이 되지 않았을 때는 wait를 통해 실행을 중단한다.
  2. 특정 프로세스가 실행될 조건이 충족되었을 때에는 signal을 통해 실행을 재개한다.
